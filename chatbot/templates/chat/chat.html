{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatbot SQL Tester</title>
  <!-- Swiper.js CDN for mobile property carousel -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <style>
    html, body {
      height: 100%;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #fcf8f3;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    /* Global Swiper Styles for Mobile */
    @media (max-width: 768px) {
      .swiper {
        width: 100%;
        height: 100%;
      }

      .swiper-slide {
        text-align: center;
        font-size: 18px;
        background: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    }
    .tw-header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px 10px 20px;
      background: #fcf8f3;
      /* box-shadow: 0 2px 12px rgba(193,90,46,0.04); */
      border-radius: 0;
      margin: 0;
      height: 56px;
    }
    .tw-header-icon {
      background: #fff;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(193,90,46,0.08);
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
      padding: 0;
    }
    .tw-header-icon:active, .tw-header-icon:focus {
      box-shadow: 0 4px 16px rgba(193,90,46,0.16);
      outline: none;
    }
    .tw-header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      position: absolute;
      left: 0; right: 0;
      pointer-events: none;
    }
    .tw-header-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fff;
      border: none;
      border-radius: 999px;
      box-shadow: 0 2px 8px rgba(193,90,46,0.10);
      padding: 6px 28px 6px 16px;
      font-size: 1.3rem;
      font-weight: bold;
      color: #c15a2e;
      cursor: pointer;
      pointer-events: auto;
      transition: box-shadow 0.2s, background 0.2s;
      text-decoration: none !important;
    }
    .tw-header-pill:active, .tw-header-pill:focus {
      box-shadow: 0 4px 16px rgba(193,90,46,0.16);
      outline: none;
    }
    .tw-header-logo {
      height: 32px;
      width: 32px;
      object-fit: contain;
      border-radius: 8px;
      background: white;
    }
    .tw-header-title {
      color: #c15a2e;
      font-weight: bold;
      font-size: 1.2rem;
      letter-spacing: 0.5px;
    }
    @media (max-width: 700px) {
      body {
        margin: 0;
      }
      .tw-header {
        padding: 10px 8px 10px 8px;
        margin-bottom: 16px;
        border-radius: 0;
        height: 56px;
      }
      .tw-header-logo {
        height: 26px;
        width: 26px;
      }
      .tw-header-pill {
        font-size: 1rem;
        padding: 4px 16px 4px 10px;
      }
      .tw-header-icon {
        width: 36px;
        height: 36px;
      }
    }
    .chat-box {
      max-width: 600px;
      margin: auto;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
    }
    .user {
      background-color: #c15a2e;
      color: white;
      text-align: right;
    }
    .bot {
      background-color: #f2f2f2;
      white-space: pre-line;
    }
    .input-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    input[type="text"] {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
    }
    button {
      padding: 10px 16px;
      background-color: #c15a2e;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    /* Responsive property card */
    .property-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      display: flex;
      gap: 10px;
      background-color: #f9f9f9;
      align-items: center;
      transition: box-shadow 0.2s, transform 0.2s;
      cursor: pointer;
    }
    .property-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      transform: translateY(-2px) scale(1.01);
    }
    .property-card img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }

    /* Thinking Animation */
    .thinking-animation {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 18px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(193,90,46,0.07);
      align-self: flex-start;
      border-bottom-left-radius: 6px;
      border-top-right-radius: 18px;
      border-top-left-radius: 18px;
      border-bottom-right-radius: 18px;
      max-width: 80%;
      margin: 2px 0;
    }

    .thinking-dot {
      width: 8px;
      height: 8px;
      background: #c15a2e;
      border-radius: 50%;
      animation: thinking 1.4s infinite ease-in-out;
    }

    .thinking-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .thinking-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    .thinking-dot:nth-child(3) {
      animation-delay: 0s;
    }

    @keyframes thinking {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Mobile responsive thinking animation */
    @media (max-width: 768px) {
      .thinking-animation {
        max-width: 90vw;
        padding: 10px 16px;
        gap: 3px;
      }

      .thinking-dot {
        width: 6px;
        height: 6px;
      }
    }

    /* Chat History Pills */
    .chat-history-pill {
      display: block;
      width: calc(100% - 16px);
      padding: 10px 12px;
      margin: 0 8px 8px 8px;
      background: #ffffff;
      border: 2px solid #c15a2e;
      border-radius: 16px;
      text-decoration: none;
      color: #495057;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      text-align: left;
      box-sizing: border-box;
      max-width: 100%;
      overflow: hidden;
    }

    .chat-history-pill:hover {
      background: #fff5f2;
      border-color: #a3471e;
      color: #c15a2e;
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(193, 90, 46, 0.2);
    }

    .chat-history-pill.active {
      background: #c15a2e;
      border-color: #c15a2e;
      color: white;
      box-shadow: 0 3px 12px rgba(193, 90, 46, 0.3);
    }

    .chat-history-pill .chat-title {
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
      line-height: 1.2;
    }

    .chat-history-pill .chat-meta {
      font-size: 0.75rem;
      opacity: 0.8;
      font-weight: 400;
      line-height: 1.2;
    }

    .chat-history-pill.active .chat-meta {
      opacity: 0.9;
    }

    /* Chat history container */
    #chat-history-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 4px;
    }

    #chat-history-container::-webkit-scrollbar {
      width: 4px;
    }

    #chat-history-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }

    #chat-history-container::-webkit-scrollbar-thumb {
      background: #c15a2e;
      border-radius: 2px;
    }

    #chat-history-container::-webkit-scrollbar-thumb:hover {
      background: #a3471e;
    }

    /* Mobile responsive chat history pills */
    @media (max-width: 768px) {
      .chat-history-pill {
        width: calc(100% - 12px);
        margin: 0 6px 8px 6px;
        padding: 12px 14px;
        font-size: 0.9rem;
        border-radius: 18px;
      }

      .chat-history-pill .chat-title {
        font-size: 0.95rem;
      }

      .chat-history-pill .chat-meta {
        font-size: 0.8rem;
      }

      #chat-history-container {
        max-height: 250px;
      }
    }
    /* Sidebar styles */
    .tw-sidebar {
      position: fixed;
      top: 56px; /* height of header */
      left: 0;
      height: calc(100vh - 56px);
      width: 260px;
      background: #fff;
      box-shadow: 2px 0 16px rgba(193,90,46,0.10);
      z-index: 1001;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(.4,0,.2,1);
      display: flex;
      flex-direction: column;
      border-radius: 0 18px 18px 0;
    }
    .tw-sidebar.open {
      transform: translateX(0);
    }
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(30, 30, 30, 0.35);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .sidebar-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }
    .tw-sidebar-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: #c15a2e;
      align-self: flex-end;
      margin: 12px 16px 0 0;
      cursor: pointer;
    }
    .tw-sidebar-content {
      padding: 24px 20px;
    }
    .tw-sidebar-content h3 {
      color: #c15a2e;
      margin-bottom: 16px;
    }
    .tw-sidebar-content ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .tw-sidebar-content li {
      margin-bottom: 14px;
    }
    .tw-sidebar-content a {
      color: #c15a2e;
      text-decoration: none;
      font-weight: 500;
      font-size: 1.08rem;
      transition: color 0.2s;
    }
    .tw-sidebar-content a:hover {
      color: #a3471e;
    }
    /* Responsive header icons */
    .tw-header-icon, .tw-header-pill {
      min-width: 0;
      min-height: 0;
    }
    @media (max-width: 700px) {
      .tw-header {
        padding: 6px 2vw 6px 2vw;
      }
      .tw-header-logo {
        height: 22px;
        width: 22px;
      }
      .tw-header-pill {
        font-size: 0.95rem;
        padding: 3px 10vw 3px 2vw;
      }
      .tw-header-icon {
        width: 32px;
        height: 32px;
      }
      .tw-sidebar {
        width: 70vw;
        min-width: 180px;
        max-width: 320px;
      }
    }
    .chat-container {
      position: absolute;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: calc(100vh - 56px);
      min-height: 0;
      width: 100vw;
      box-sizing: border-box;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }
    .chat-box {
      width: 100%;
      max-width: 900px;
      background: none;
      margin: 0 auto 0 auto;
      padding: 0 32px;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      /* Pin input to bottom, messages fill above */
    }
    #messages {
      flex: 1 1 auto;
      overflow-y: auto;
      min-height: 0;
      margin: 0;
      padding: 12px 0 10px 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      box-sizing: border-box;
      gap: 8px;
      /* Hide scrollbar arrows and minimize scrollbar */
      scrollbar-width: thin;
      scrollbar-color: #f2f2f2 #fcf8f3;
    }
    #messages::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    #messages::-webkit-scrollbar-thumb {
      background: #f2f2f2;
      border-radius: 8px;
    }
    #messages::-webkit-scrollbar-button {
      display: none;
      height: 0;
      width: 0;
    }
    .message {
      font-size: 0.95rem;
      line-height: 1.5;
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      margin: 2px 0;
      box-shadow: 0 2px 8px rgba(193,90,46,0.07);
      word-break: break-word;
      transition: background 0.2s, color 0.2s;
      position: relative;
      display: inline-block;
    }
    .message.user {
      background: #c15a2e;
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
      border-top-right-radius: 18px;
      border-top-left-radius: 18px;
      border-bottom-left-radius: 18px;
      box-shadow: 0 2px 8px rgba(193,90,46,0.13);
      text-align: left;
    }
    .message.bot {
      background: #fff;
      color: #111;
      align-self: flex-start;
      border-bottom-left-radius: 6px;
      border-top-right-radius: 18px;
      border-top-left-radius: 18px;
      border-bottom-right-radius: 18px;
      box-shadow: 0 2px 8px rgba(193,90,46,0.07);
      text-align: left;
    }
    /* Modern input bar */
    .input-group {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0;
      padding: 16px 0 16px 0;
      flex-shrink: 0;
      background: none;
      border: none;
      box-shadow: none;
      width: 100%;
      justify-content: center;
    }
    .input-group input[type="text"] {
      flex: 1;
      padding: 14px 18px;
      font-size: 1rem;
      border: none;
      border-radius: 24px 0 0 24px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(193,90,46,0.10);
      outline: none;
      color: #333;
      transition: box-shadow 0.2s;
    }
    .input-group input[type="text"]:focus {
      box-shadow: 0 4px 16px rgba(193,90,46,0.18);
    }
    .input-group button {
      padding: 0 26px;
      background-color: #c15a2e;
      color: #fff;
      border: none;
      border-radius: 0 24px 24px 0;
      font-weight: bold;
      font-size: 1rem;
      height: 48px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(193,90,46,0.10);
      transition: background 0.2s, box-shadow 0.2s;
      margin-left: -2px;
    }
    .input-group button:active, .input-group button:focus {
      background: #a3471e;
      box-shadow: 0 4px 16px rgba(193,90,46,0.18);
      outline: none;
    }
    @media (max-width: 700px) {
      .chat-box {
        max-width: 100vw;
        padding: 0 2vw;
      }
      .message {
        font-size: 0.90rem;
        padding: 10px 12px;
        max-width: 95%;
      }
      .input-group input[type="text"] {
        font-size: 0.98rem;
        padding: 12px 12px;
      }
      .input-group button {
        font-size: 0.98rem;
        height: 42px;
        padding: 0 16px;
      }
    }
    .property-card-js {
      width: 320px;
      min-width: 0;
      max-width: 100%;
      height: auto;
      min-height: 0;
      border: 1px solid #eee;
      border-radius: 10px;
      margin: 0;
      padding: 0;
      background: #fff;
      box-shadow: 0 2px 8px rgba(193,90,46,0.07);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: box-shadow 0.2s, transform 0.2s;
      cursor: pointer;
      overflow: hidden;
    }
    .property-card-js:hover {
      box-shadow: 0 4px 16px rgba(193,90,46,0.13);
      transform: translateY(-2px) scale(1.01);
    }
    .property-card-img-section-js {
      width: 100%;
      height: 180px;
      background: #f2f2f2;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .property-card-img-js {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
      background: #f2f2f2;
    }
    @media (max-width: 600px) {
      .property-card-js {
        width: 98vw;
        max-width: 98vw;
      }
    }

    /* Two-column property grid layout */
    #property-grid {
      display: grid !important;
      grid-template-columns: 340px 340px;
      gap: 20px 8px;
      width: 100%;
      margin: 0;
      padding: 0;
      justify-items: start;
      align-items: start;
    }
    @media (max-width: 700px) {
      #property-grid {
        grid-template-columns: 1fr;
        gap: 8px 0;
      }
    }
    .sidebar-account {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 28px;
      padding-bottom: 18px;
      border-bottom: 1px solid #f2f2f2;
      background: none;
    }
    .sidebar-account-avatar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sidebar-profile-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: #f2f2f2;
      border: 2px solid #eee;
      box-shadow: 0 2px 8px rgba(193,90,46,0.08);
    }
    .sidebar-account-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      justify-content: center;
    }
    .sidebar-account-name {
      font-weight: 600;
      color: #c15a2e;
      font-size: 1.12rem;
      margin-bottom: 2px;
    }
    .sidebar-account-email {
      font-size: 0.98rem;
      color: #888;
      margin-bottom: 4px;
    }
    .sidebar-dashboard-btn {
      display: inline-block;
      background: #c15a2e;
      color: #fff;
      border-radius: 18px;
      padding: 6px 18px;
      font-size: 0.98rem;
      text-decoration: none;
      font-weight: 500;
      margin-top: 4px;
      transition: background 0.2s;
      text-align: center;
    }
    .sidebar-dashboard-btn:hover {
      background: #a3471e;
    }
    .sidebar-svg-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: #f2f2f2;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(193,90,46,0.10);
      margin-bottom: 1.2rem;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      overflow: hidden;
    }
    .sidebar-svg-icon {
      width: 72px;
      height: 72px;
      display: block;
    }
    .sidebar-account-block {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 16px;
      padding-bottom: 16px;
    }
    .sidebar-account-name {
      width: 100%;
      text-align: center;
      margin: 0 auto 0.25rem auto;
      display: block;
      color: #111;
      font-size: 1.18rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .sidebar-account-email {
      width: 100%;
      text-align: center;
      margin: 0 auto 0.15rem auto;
      display: block;
      color: #222;
      font-size: 1rem;
      font-weight: 400;
      letter-spacing: 0.01em;
    }
    .sidebar-account-phone {
      width: 100%;
      text-align: center;
      margin: 0 auto 0.7rem auto;
      display: block;
      color: #222;
      font-size: 1rem;
      font-weight: 400;
      letter-spacing: 0.01em;
    }
    .sidebar-dashboard-btn {
      display: inline-block;
      margin-bottom: 0.5rem;
      background: linear-gradient(90deg, #c15a2e 0%, #e07a3f 100%);
      color: #fff !important;
      border: none;
      box-shadow: 0 2px 8px rgba(59,130,246,0.10);
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      transition: background 0.2s, box-shadow 0.2s;
      border-radius: 999px !important;
      padding: 0.5rem 2.2rem;
      min-width: 160px;
      text-align: center;
    }
    .sidebar-dashboard-btn:hover {
      background: linear-gradient(90deg, #a3471e 0%, #e07a3f 100%);
      color: #fff !important;
      box-shadow: 0 4px 16px rgba(59,130,246,0.13);
    }
    .sidebar-account-divider {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      border: none;
      border-top: 1.5px solid #eee;
      width: 100%;
    }
    .sidebar-auth-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 80%;
      margin-left: auto;
      margin-right: auto;
      padding: 0.5rem 1.5rem;
      font-size: 1.05rem;
      font-weight: 600;
      border-radius: 999px !important;
      background: linear-gradient(90deg, #c15a2e 0%, #e07a3f 100%);
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(193,90,46,0.10);
      border: none;
      transition: background 0.2s, box-shadow 0.2s;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .sidebar-auth-btn:hover {
      background: linear-gradient(90deg, #a3471e 0%, #e07a3f 100%);
      color: #fff !important;
      box-shadow: 0 4px 16px rgba(193,90,46,0.13);
    }
    .sidebar-auth-icon {
      width: 1.3em;
      height: 1.3em;
      margin-right: 0.5em;
      vertical-align: middle;
      stroke: #fff;
    }
    @media (max-width: 600px) {
      .sidebar-auth-btn {
        width: 98%;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
    }
    .sidebar-profile-photo {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 0;
      box-shadow: none;
    }
    /* Responsive layout for mobile screens */
    @media (max-width: 768px) {
      .tw-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100vw;
        height: 64px;
        z-index: 100;
        padding: 0 0.5rem;
        font-size: 1.1rem;
        background: #fcf8f3;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .tw-header-logo {
        height: 2rem;
        width: 2rem;
      }
      .tw-header-title {
        font-size: 1.1rem;
      }
      .tw-header-pill {
        font-size: 1rem;
        padding: 0.4rem 1.2rem 0.4rem 0.8rem;
        min-width: 0;
        max-width: 90vw;
      }
      .tw-header-icon {
        width: 2.2rem;
        height: 2.2rem;
        min-width: 2.2rem;
        min-height: 2.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .tw-header-icon.tw-hamburger svg rect {
        width: 18px;
        x: 5;
      }
      .tw-header-icon.tw-plus {
        right: 0.3rem;
        position: relative;
        width: 2.2rem;
        height: 2.2rem;
        min-width: 2.2rem;
        min-height: 2.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
      }
      .tw-header-icon.tw-plus svg {
        width: 22px;
        height: 22px;
        margin-right: 0;
      }
      .chat-container {
        width: 100vw;
        min-width: 0;
        padding: 0;
        margin: 0;
      }
      .chat-box {
        width: 100vw;
        max-width: 100vw;
        min-width: 0;
        margin: 0;
        padding: 0 0.5rem;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 64px);
        min-height: 0;
      }
      #messages {
        flex: 1 1 auto;
        overflow-y: auto;
        min-height: 0;
        margin-top: 80px;
        margin-bottom: 80px;
        padding: 0.5rem 0 0.5rem 0;
        box-sizing: border-box;
        width: 100%;
      }
      .input-group {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100vw;
        background: #fff;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.5rem 1rem 0.5rem;
        z-index: 200;
        border-top-left-radius: 1.2rem;
        border-top-right-radius: 1.2rem;
        box-shadow: 0 -2px 12px rgba(193,90,46,0.07);
      }
      .input-group input[type="text"] {
        font-size: 1rem;
        padding: 0.7rem 1rem;
        border-radius: 1.2rem;
        width: 100%;
        min-width: 0;
        border: none;
        outline: none;
        background: #f9f5ef;
        color: #222;
      }
      .input-group button {
        font-size: 1rem;
        border-radius: 1.2rem;
        padding: 0.7rem 1.2rem;
        min-width: 2.5rem;
        background: #c15a2e;
        color: #fff;
        border: none;
        font-weight: 600;
        box-shadow: none;
      }
      .property-card-js, .property-card {
        width: 98vw !important;
        max-width: 98vw !important;
        min-width: 0;
        margin: 0 auto 10px auto;
        flex-direction: column;
        align-items: flex-start;
      }
      .property-card-img-section-js, .property-card img {
        width: 100%;
        height: auto;
        max-width: 100vw;
        object-fit: cover;
        border-radius: 1rem 1rem 0 0;
      }
      .property-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem 0;
        width: 100vw;
        padding: 0;
        margin: 0 auto;
      }
      .message, .tw-message {
        max-width: 90vw;
        font-size: 1rem;
        padding: 0.7rem 1rem;
        border-radius: 1.2rem;
        margin: 0.3rem 0;
        word-break: break-word;
      }
    }
    @media (max-width: 768px) {
      .property-card-js, .property-card {
        width: 96vw !important;
        max-width: 96vw !important;
        min-width: 0;
        margin: 0.7rem auto 1.2rem auto;
        border-radius: 1.3rem;
        background: #fff;
        box-shadow: 0 2px 8px rgba(44,44,44,0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.1rem 0 1.2rem 0;
      }
      .property-card-img-mobile-container {
        width: 60vw;
        max-width: 60vw;
        aspect-ratio: 1/1;
        border-radius: 1.1rem;
        overflow: hidden;
        background: #f2f2f2;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.1rem auto;
      }
      .property-card-img-mobile {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 1.1rem;
        display: block;
      }
      .property-card-title-mobile {
        font-size: 1.15rem;
        font-weight: 700;
        text-align: center;
        margin: 0.5rem 0 0.2rem 0;
        color: #222;
      }
      .property-card-location-mobile {
        font-size: 1rem;
        color: #888;
        text-align: center;
        margin-bottom: 0.2rem;
      }
      .property-card-price-mobile {
        font-size: 1.1rem;
        color: #c15a2e;
        font-weight: 700;
        text-align: center;
        margin-top: 0.3rem;
      }
    }
    @media (max-width: 768px) {
      /* Swiper Property Card Styles */
      .swiper-property-card {
        width: 100%;
        margin-bottom: 2rem;
        padding: 0 1rem;
      }

      .property-swiper {
        width: 80vw;
        max-width: 300px;
        height: 60vw;
        max-height: 300px;
        margin: 0 auto 1rem auto;
        border-radius: 1.1rem;
        overflow: hidden;
        background: #f2f2f2;
      }

      .property-swiper .swiper-slide {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .property-swiper-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 1.1rem;
      }

      /* Swiper Navigation Buttons */
      .property-swiper .swiper-button-next,
      .property-swiper .swiper-button-prev {
        width: 30px;
        height: 30px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        color: #c15a2e;
        font-size: 12px;
      }

      .property-swiper .swiper-button-next:after,
      .property-swiper .swiper-button-prev:after {
        font-size: 12px;
        font-weight: bold;
      }

      /* Swiper Pagination */
      .property-swiper .swiper-pagination {
        bottom: 10px;
      }

      .property-swiper .swiper-pagination-bullet {
        width: 8px;
        height: 8px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 1;
      }

      .property-swiper .swiper-pagination-bullet-active {
        background: #c15a2e;
      }

      /* Legacy mobile carousel styles (keeping for compatibility) */
      .property-card-img-mobile-carousel {
        width: 60vw;
        max-width: 60vw;
        aspect-ratio: 1/1;
        border-radius: 1.1rem;
        overflow-x: auto;
        overflow-y: hidden;
        background: #f2f2f2;
        display: flex;
        align-items: center;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        margin: 0 auto 1.1rem auto;
      }
      .property-card-img-mobile-slide {
        flex: 0 0 100%;
        width: 60vw;
        height: 60vw;
        max-width: 60vw;
        max-height: 60vw;
        border-radius: 1.1rem;
        object-fit: cover;
        scroll-snap-align: center;
        display: block;
      }
      .property-card-carousel-dots {
        display: flex;
        justify-content: center;
        gap: 0.3rem;
        margin: 0.4rem 0 0.2rem 0;
      }
      .property-card-carousel-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e0e0e0;
        transition: background 0.2s;
      }
      .property-card-carousel-dot.active {
        background: #c15a2e;
      }
    }

    /* Properties Modal Styles */
    .properties-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .properties-modal.show {
      display: flex;
      opacity: 1;
    }

    .properties-modal-panel {
      background: white;
      border-radius: 16px;
      width: 95vw;
      height: 90vh;
      max-width: 1200px;
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .properties-modal.show .properties-modal-panel {
      transform: scale(1);
    }

    .properties-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .properties-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin: 0;
    }

    .properties-modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
      line-height: 1;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .properties-modal-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .properties-modal-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      min-height: 0;
    }

    .properties-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 24px;
      width: 100%;
    }

    @media (max-width: 768px) {
      .properties-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .properties-modal-panel {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
      }

      .properties-modal-header {
        padding: 16px 20px;
      }

      .properties-modal-title {
        font-size: 1.25rem;
      }

      .properties-modal-content {
        padding: 20px 16px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .properties-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1025px) {
      .properties-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Property Card in Modal */
    .modal-property-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s ease;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .modal-property-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      transform: translateY(-4px);
    }

    .modal-property-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f3f4f6;
    }

    .modal-property-content {
      padding: 16px;
    }

    .modal-property-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      margin: 0 0 8px 0;
      line-height: 1.4;
    }

    .modal-property-location {
      font-size: 0.9rem;
      color: #6b7280;
      margin: 0 0 8px 0;
    }

    .modal-property-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: #c15a2e;
      margin: 0;
    }

    .modal-property-distance {
      font-size: 0.85rem;
      color: #059669;
      margin: 4px 0 0 0;
      font-weight: 500;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid #c15a2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* View Properties Button */
    .view-properties-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #c15a2e;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      font-size: 1rem;
      margin-top: 8px;
    }

    .view-properties-btn:hover {
      background: #a3471e;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(193, 90, 46, 0.3);
      color: white;
      text-decoration: none;
    }

    .view-properties-btn-icon {
      font-size: 1.2rem;
    }

    /* Chat Bubble with View Properties Button */
    .chat-bubble-with-button {
      background: #fff;
      border-radius: 18px;
      padding: 16px 20px;
      max-width: 80%;
      align-self: flex-start;
      box-shadow: 0 2px 8px rgba(193,90,46,0.07);
      border-bottom-left-radius: 6px;
      margin: 2px 0;
    }

    /* Infinite Scroll Indicator */
    .infinite-scroll-loader {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      margin-top: 20px;
    }

    .infinite-scroll-loader.hidden {
      display: none;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      color: #d1d5db;
    }

    .empty-state-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }

    .empty-state-description {
      font-size: 1rem;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="tw-sidebar" class="tw-sidebar">
    <div class="tw-sidebar-content">
      <!-- Desktop Sidebar User/Profile Section -->
      <div class="flex flex-col items-center mb-6 sidebar-account-block">
        {% if user.is_authenticated %}
          {% if user.profile_photo %}
            <div class="sidebar-svg-avatar">
              <img src="{{ user.profile_photo.url }}" alt="Profile Photo" class="sidebar-profile-photo" />
            </div>
          {% else %}
            <div class="sidebar-svg-avatar">
              <svg class="sidebar-svg-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="24" r="24" fill="#f2f2f2"/>
                <path d="M24 24c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7 3.582 7 8 7z" fill="#c15a2e"/>
                <path d="M12 36c0-4.418 5.373-8 12-8s12 3.582 12 8v2a2 2 0 01-2 2H14a2 2 0 01-2-2v-2z" fill="#c15a2e"/>
              </svg>
            </div>
          {% endif %}
          <h2 class="sidebar-account-name text-xl font-bold text-gray-800 text-center mt-2 mb-1">
            {{ user.get_full_name|default:user.username }}
          </h2>
          <p class="sidebar-account-email text-gray-500 text-sm text-center mb-1">{{ user.email }}</p>
          <p class="sidebar-account-phone text-gray-500 text-sm text-center mb-3">{{ user.phone_number|default:'No phone number' }}</p>
          <a href="{% if user.user_type == 'host' %}{% url 'host_dashboard' %}{% else %}{% url 'tenant_dashboard' %}{% endif %}"
               class="sidebar-dashboard-btn">
               Go to Dashboard
          </a>


          <hr class="sidebar-account-divider my-2 w-full" style="border: none; border-top: 1.5px solid #eee;">
        {% else %}
          <div class="sidebar-svg-avatar">
            <svg class="sidebar-svg-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="24" cy="24" r="24" fill="#f2f2f2"/>
              <path d="M24 24c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7 3.582 7 8 7z" fill="#c15a2e"/>
              <path d="M12 36c0-4.418 5.373-8 12-8s12 3.582 12 8v2a2 2 0 01-2 2H14a2 2 0 01-2-2v-2z" fill="#c15a2e"/>
            </svg>
          </div>
          <h2 class="sidebar-account-name text-xl font-bold text-gray-800 text-center mt-2 mb-1">Guest</h2>
          <p class="sidebar-account-email text-gray-500 text-sm text-center mb-1">Not logged in</p>
          <p class="sidebar-account-phone text-gray-500 text-sm text-center mb-3">&nbsp;</p>
          <a href="{% url 'login' %}?next={% url 'chat' %}"
             class="sidebar-dashboard-btn sidebar-auth-btn mb-2">
            <svg class="sidebar-auth-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
            Login
          </a>
          <a href="{% url 'signup' %}?next={% url 'chat' %}"
             class="sidebar-dashboard-btn sidebar-auth-btn">
            <svg class="sidebar-auth-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Sign Up
          </a>
          <hr class="sidebar-account-divider my-2 w-full" style="border: none; border-top: 1.5px solid #eee;">
        {% endif %}
      </div>

      <!-- History Section -->
      <div class="border-t border-gray-200 pt-4 mb-4">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">History</h3>
        {% if user.is_authenticated %}
          <div id="chat-history-container">
            <div class="text-gray-500 text-sm px-3 py-2">Loading chat history...</div>
          </div>
        {% else %}
          <div class="text-gray-500 text-sm px-3 py-2">You need to be logged in to view history</div>
        {% endif %}
      </div>

    </div>
  </div>
  <div id="sidebar-overlay" class="sidebar-overlay"></div>

  <!-- Properties Modal -->
  <div id="properties-modal" class="properties-modal">
    <div class="properties-modal-panel">
      <div class="properties-modal-header">
        <h2 id="properties-modal-title" class="properties-modal-title">Properties</h2>
        <button class="properties-modal-close" onclick="closePropertiesModal()" aria-label="Close">
          √ó
        </button>
      </div>
      <div class="properties-modal-content">
        <div id="properties-grid" class="properties-grid">
          <!-- Properties will be populated here -->
        </div>
        <div id="infinite-scroll-loader" class="infinite-scroll-loader hidden">
          <div class="spinner"></div>
        </div>
        <div id="empty-state" class="empty-state" style="display: none;">
          <div class="empty-state-icon">üè†</div>
          <div class="empty-state-title">No Properties Found</div>
          <div class="empty-state-description">
            Try adjusting your search criteria or browse our featured listings.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Header Bar -->
  <header class="tw-header">

    <button class="tw-header-icon tw-hamburger hidden md:flex" aria-label="Menu" onclick="openSidebar()">
      <!-- Desktop-only Hamburger Button -->
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect  y="6" width="28" height="3" rx="1.5" fill="#c15a2e"/>
        <rect  y="13" width="28" height="3" rx="1.5" fill="#c15a2e"/>
        <rect  y="20" width="28" height="3" rx="1.5" fill="#c15a2e"/>
      </svg>
    </button>

    <!-- Mobile-only Hamburger Button -->
    <button class="tw-header-icon tw-hamburger block md:hidden" aria-label="Menu" onclick="openSidebar()">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="5" y="6" width="28" height="3" rx="1.5" fill="#c15a2e"/>
        <rect x="5" y="13" width="28" height="3" rx="1.5" fill="#c15a2e"/>
        <rect x="5" y="20" width="28" height="3" rx="1.5" fill="#c15a2e"/>
      </svg>
    </button>

    <div class="tw-header-center">
        <a href="{% url 'home' %}" class="tw-header-pill">
            <img src="{% static 'images/logo-black.png' %}" alt="Tourwise Logo" class="tw-header-logo">
            <span class="tw-header-title">Tourwise</span>
        </a>
    </div>
    <button class="tw-header-icon tw-plus" aria-label="Add" onclick="startNewChat()">
      <!-- Plus in circle SVG -->
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="14" cy="14" r="13" fill="#fff" stroke="#c15a2e" stroke-width="2"/>
        <rect x="13" y="8" width="2" height="12" rx="1" fill="#c15a2e"/>
        <rect x="8" y="13" width="12" height="2" rx="1" fill="#c15a2e"/>
      </svg>
    </button>
  </header>
  <!-- End Header Bar -->
  <div class="chat-container">
  <div class="chat-box" id="chat-box">
    <div id="messages"></div>
    <div class="input-group">
      <input type="text" id="user-input" placeholder="e.g. Show me houses in Harare under $500" />
      <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
<script>
// Django template variable for authentication status
const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
</script>

<script>
const WELCOME_MESSAGE = `üëã Hey there, welcome to Tourwise!\nI'm your virtual assistant, here to help you find your perfect home ‚Äî stress-free and hassle-free. üè°‚ú®\nJust tell me what you're looking for, and I'll do the searching for you.\nWhether you're after something specific or just browsing, I've got you covered.\nLet's get started ‚Äî your next home could be just one message away! üòä`;

// Global state for properties modal
let modalProperties = [];
let currentPage = 1;
let itemsPerPage = 20;
let isLoading = false;
let hasMoreItems = true;

function appendMessage(text, sender) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message ' + sender;
  msgDiv.textContent = text;
  document.getElementById('messages').appendChild(msgDiv);
}

// Create chat bubble with View Properties button
function createChatBubbleWithButton(message, properties) {
  const bubbleDiv = document.createElement('div');
  bubbleDiv.className = 'chat-bubble-with-button';

  const messageText = document.createElement('div');
  messageText.textContent = message;
  messageText.style.marginBottom = '8px';

  const viewButton = document.createElement('button');
  viewButton.className = 'view-properties-btn';
  viewButton.innerHTML = `
    <span class="view-properties-btn-icon"></span>
    View Properties
  `;
  viewButton.onclick = () => openPropertiesModal(properties, message);

  bubbleDiv.appendChild(messageText);
  bubbleDiv.appendChild(viewButton);
  document.getElementById('messages').appendChild(bubbleDiv);
}

// Open properties modal
function openPropertiesModal(properties, title = 'Properties') {
  modalProperties = [...properties];
  currentPage = 1;
  hasMoreItems = true;
  isLoading = false;

  const modal = document.getElementById('properties-modal');
  const modalTitle = document.getElementById('properties-modal-title');
  const grid = document.getElementById('properties-grid');
  const emptyState = document.getElementById('empty-state');

  modalTitle.textContent = `${properties.length} ${properties.length === 1 ? 'Property' : 'Properties'} Found`;

  // Clear previous content
  grid.innerHTML = '';
  emptyState.style.display = 'none';

  if (properties.length === 0) {
    emptyState.style.display = 'block';
  } else {
    // Load initial batch
    loadPropertiesPage();
  }

  // Show modal
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';

  // Setup infinite scroll
  setupInfiniteScroll();
}

// Close properties modal
function closePropertiesModal() {
  const modal = document.getElementById('properties-modal');
  modal.classList.remove('show');
  document.body.style.overflow = '';

  // Reset state
  modalProperties = [];
  currentPage = 1;
  hasMoreItems = true;
  isLoading = false;
}

// Load a page of properties
function loadPropertiesPage() {
  if (isLoading || !hasMoreItems) return;

  isLoading = true;
  const loader = document.getElementById('infinite-scroll-loader');
  loader.classList.remove('hidden');

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageProperties = modalProperties.slice(startIndex, endIndex);

  // Simulate loading delay for smooth UX
  setTimeout(() => {
    const grid = document.getElementById('properties-grid');

    pageProperties.forEach(property => {
      const card = createModalPropertyCard(property);
      grid.appendChild(card);
    });

    currentPage++;
    hasMoreItems = endIndex < modalProperties.length;
    isLoading = false;
    loader.classList.add('hidden');
  }, 300);
}

// Create property card for modal
function createModalPropertyCard(property) {
  const card = document.createElement('div');
  card.className = 'modal-property-card';
  card.onclick = () => {
    window.location.href = `/listings/${property.id}/`;
  };

  // Image
  let imageUrl = property.main_image || '';
  if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
    imageUrl = '/media/' + imageUrl;
  }
  if (!imageUrl) {
    imageUrl = '/static/images/default-profile-icon.png';
  }

  const img = document.createElement('img');
  img.src = imageUrl;
  img.alt = property.title || 'Property Image';
  img.className = 'modal-property-image';
  img.loading = 'lazy'; // Lazy load for performance

  // Content
  const content = document.createElement('div');
  content.className = 'modal-property-content';

  const title = document.createElement('h3');
  title.className = 'modal-property-title';
  title.textContent = property.title || 'Property';

  const location = document.createElement('p');
  location.className = 'modal-property-location';
  const city = property.city || '';
  const suburb = property.suburb || '';
  location.textContent = city && suburb ? `${suburb}, ${city}` : city || suburb || 'Location not specified';

  const price = document.createElement('p');
  price.className = 'modal-property-price';
  price.textContent = property.price ? `$${property.price}` : 'Price on request';

  content.appendChild(title);
  content.appendChild(location);
  content.appendChild(price);

  // Add distance if available (for CBD searches)
  if (property.distance_from_cbd) {
    const distance = document.createElement('p');
    distance.className = 'modal-property-distance';
    distance.textContent = `${property.distance_from_cbd}km from CBD`;
    content.appendChild(distance);
  }

  card.appendChild(img);
  card.appendChild(content);

  return card;
}

// Setup infinite scroll
function setupInfiniteScroll() {
  const modalContent = document.querySelector('.properties-modal-content');

  const scrollHandler = () => {
    if (isLoading || !hasMoreItems) return;

    const scrollTop = modalContent.scrollTop;
    const scrollHeight = modalContent.scrollHeight;
    const clientHeight = modalContent.clientHeight;

    // Load more when user is 100px from bottom
    if (scrollTop + clientHeight >= scrollHeight - 100) {
      loadPropertiesPage();
    }
  };

  modalContent.addEventListener('scroll', scrollHandler);

  // Clean up on modal close
  const modal = document.getElementById('properties-modal');
  modal.addEventListener('transitionend', (e) => {
    if (e.target === modal && !modal.classList.contains('show')) {
      modalContent.removeEventListener('scroll', scrollHandler);
    }
  });
}

// Show thinking animation
function showThinking() {
  const thinkingDiv = document.createElement('div');
  thinkingDiv.className = 'thinking-animation';
  thinkingDiv.id = 'thinking-animation';

  // Create three dots
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement('div');
    dot.className = 'thinking-dot';
    thinkingDiv.appendChild(dot);
  }

  document.getElementById('messages').appendChild(thinkingDiv);

  // Scroll to bottom to show the animation
  const messagesDiv = document.getElementById('messages');
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Hide thinking animation
function hideThinking() {
  const thinkingDiv = document.getElementById('thinking-animation');
  if (thinkingDiv) {
    thinkingDiv.remove();
  }
}

// --- Tailwind-based Property Card Rendering ---
function appendCard(property) {
  // Debug: Log the property data being processed
  console.log("üîç appendCard called with property:", property);
  console.log("üîç Property title:", property.title);
  console.log("üîç Property price:", property.price);
  console.log("üîç Property city:", property.city);
  console.log("üîç Property suburb:", property.suburb);
  console.log("üîç Property main_image:", property.main_image);

  // Always check for and create the property grid if it doesn't exist
  let grid = document.getElementById('property-grid');
  if (!grid) {
    grid = document.createElement('div');
    grid.id = 'property-grid';
    const messagesDiv = document.getElementById('messages');
    let lastMsg = messagesDiv.lastElementChild;
    if (lastMsg && lastMsg.id === 'property-grid') {
      grid = lastMsg;
    } else {
      messagesDiv.appendChild(grid);
    }
  }

  // Mobile layout with Swiper coverflow
  if (window.innerWidth <= 768) {
    const card = document.createElement('div');
    card.className = 'property-card-js swiper-property-card';
    card.title = property.title || 'Property';
    card.onclick = () => {
      window.location.href = `/listings/${property.id}/`;
    };

    // Create Swiper container
    const swiperContainer = document.createElement('div');
    swiperContainer.className = 'swiper property-swiper';

    // Create Swiper wrapper
    const swiperWrapper = document.createElement('div');
    swiperWrapper.className = 'swiper-wrapper';

    // Use property.images if available, else fallback to main_image
    let images = property.images || [];
    if (!images.length && property.main_image) images = [property.main_image];

    images.forEach((imgUrl, idx) => {
      let imageUrl = imgUrl;
      if (imageUrl && !imageUrl.startsWith('http')) {
        imageUrl = '/media/' + imageUrl;
      }

      const slide = document.createElement('div');
      slide.className = 'swiper-slide';

      const img = document.createElement('img');
      img.src = imageUrl || '/static/images/default-profile-icon.png';
      img.alt = property.title || 'Property Image';
      img.className = 'property-swiper-img';
      slide.appendChild(img);

      swiperWrapper.appendChild(slide);
    });

    // Add navigation arrows
    const prevButton = document.createElement('div');
    prevButton.className = 'swiper-button-prev';
    const nextButton = document.createElement('div');
    nextButton.className = 'swiper-button-next';

    // Add pagination
    const pagination = document.createElement('div');
    pagination.className = 'swiper-pagination';

    swiperContainer.appendChild(swiperWrapper);
    swiperContainer.appendChild(prevButton);
    swiperContainer.appendChild(nextButton);
    swiperContainer.appendChild(pagination);

    // Details
    const title = document.createElement('div');
    title.className = 'property-card-title-mobile';
    title.textContent = property.title || 'Untitled Property';

    const location = document.createElement('div');
    location.className = 'property-card-location-mobile';
    location.textContent = `${property.city || ''}, ${property.suburb || ''}`;

    const price = document.createElement('div');
    price.className = 'property-card-price-mobile';
    price.textContent = `$${property.price || 'N/A'}`;

    card.appendChild(swiperContainer);
    card.appendChild(title);
    card.appendChild(location);
    card.appendChild(price);
    grid.appendChild(card);

    // Initialize Swiper after adding to DOM
    setTimeout(() => {
      if (images.length > 0) {
        new Swiper(swiperContainer, {
          effect: "coverflow",
          grabCursor: true,
          centeredSlides: true,
          loop: images.length > 1,
          slidesPerView: "auto",
          coverflowEffect: {
            rotate: 0,
            stretch: 0,
            depth: 100,
            modifier: 2.5,
            slideShadows: false,
          },
          autoplay: images.length > 1 ? {
            delay: 2500,
            disableOnInteraction: false,
          } : false,
          pagination: {
            el: pagination,
            clickable: true,
          },
          navigation: {
            nextEl: nextButton,
            prevEl: prevButton,
          },
        });
      }
    }, 100);

    return;
  }

  // Desktop layout (fallback to old)
  const card = document.createElement('article');
  card.className = 'property-card-js';
  card.title = property.title || 'Property';
  card.onclick = () => {
    window.location.href = `/listings/${property.id}/`;
  };

  // Image section
  const imgSection = document.createElement('div');
  imgSection.className = 'property-card-img-section-js';
  const img = document.createElement('img');

  // Handle main_image properly
  let imageUrl = property.main_image || '';
  console.log("üîç Original imageUrl:", imageUrl);

  if (imageUrl) {
    if (!imageUrl.startsWith('http') && !imageUrl.startsWith('/media/')) {
      imageUrl = '/media/' + imageUrl;
    }
  } else {
    imageUrl = '/static/images/default-profile-icon.png';
  }

  console.log("üîç Final imageUrl:", imageUrl);
  img.src = imageUrl;
  img.alt = property.title || 'Property Image';
  img.className = 'property-card-img-js';
  imgSection.appendChild(img);

  // Info section
  const info = document.createElement('div');
  info.style.display = 'flex';
  info.style.flexDirection = 'column';
  info.style.alignItems = 'center';
  info.style.justifyContent = 'center';
  info.style.padding = '10px 8px';
  info.style.textAlign = 'center';
  const title = document.createElement('h3');
  title.style.fontWeight = '600';
  title.style.fontSize = '1.08rem';
  title.style.color = '#333';
  title.style.margin = '0 0 2px 0';
  title.title = property.title || '';
  title.textContent = property.title || 'Property';

  const location = document.createElement('p');
  location.style.fontSize = '0.97rem';
  location.style.color = '#888';
  location.style.margin = '0 0 2px 0';
  const city = property.city || '';
  const suburb = property.suburb || '';
  const locationText = city && suburb ? `${city}, ${suburb}` : city || suburb || 'Location not specified';
  location.title = locationText;
  location.textContent = locationText;

  const price = document.createElement('p');
  price.style.fontSize = '1.05rem';
  price.style.color = '#c15a2e';
  price.style.fontWeight = 'bold';
  price.style.margin = '4px 0 0 0';
  const priceValue = property.price;
  const priceText = priceValue ? `$${priceValue}` : 'Price not specified';
  price.textContent = priceText;

  info.appendChild(title);
  info.appendChild(location);
  info.appendChild(price);

  // Assemble card
  card.appendChild(imgSection);
  card.appendChild(info);
  grid.appendChild(card);
}

function sendMessage() {
  const input = document.getElementById('user-input');
  const message = input.value.trim();
  if (!message) return;

  appendMessage(message, 'user');
  input.value = '';
  showThinking(); // Show thinking animation

  fetch("/chatbot/sql/", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": getCookie('csrftoken'),
    },
    body: "message=" + encodeURIComponent(message),
  })
  .then(res => res.json())
  .then(data => {
    hideThinking(); // Hide thinking animation

    console.log("üîç Frontend received data:", data);

    // Handle MCP response format
    if (data.error) {
      appendMessage("‚ùå " + data.error, 'bot');
      return;
    }

    // Show friendly message if present
    if (data.friendly_message) {
      appendMessage(data.friendly_message, 'bot');
    }

    // Handle property results from MCP
    if (data.result && Array.isArray(data.result)) {
      if (data.result.length === 0) {
        appendMessage("No results found.", 'bot');
      } else {
        console.log("üîç Processing properties:", data.result.length);

        // Create chat bubble with View Properties button
        const friendlyMsg = data.friendly_message || `I found ${data.result.length} properties matching your criteria.`;
        createChatBubbleWithButton(friendlyMsg, data.result);
      }
    } else if (typeof data.result === "string") {
      appendMessage(data.result, 'bot');
    } else if (data.is_conversational) {
      // Conversational response - no properties to show
      console.log("üîç Conversational response, no properties");
    } else {
      console.log("üîç Unexpected response format:", data);
      appendMessage("Unexpected response format.", 'bot');
    }
  })
  .catch(() => {
    hideThinking(); // Hide thinking animation
    appendMessage("Something went wrong. Please try again.", 'bot');
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// --- Welcome message typing animation ---
function showWelcomeMessage() {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message bot';
  messagesDiv.appendChild(msgDiv);

  const input = document.getElementById('user-input');
  const sendBtn = input.nextElementSibling;
  input.disabled = true;
  sendBtn.disabled = true;

  let i = 0;
  let cursorVisible = true;
  let displayText = '';
  const chars = WELCOME_MESSAGE;
  function typeStep() {
    if (i < chars.length) {
      displayText += chars.substr(i, 2);
      i += 2;
      msgDiv.textContent = displayText + (cursorVisible ? '|' : '');
      setTimeout(typeStep, 25);
    } else {
      // Blinking cursor for 600ms
      let blinkCount = 0;
      function blinkCursor() {
        cursorVisible = !cursorVisible;
        msgDiv.textContent = displayText + (cursorVisible ? '|' : '');
        blinkCount++;
        if (blinkCount < 6) {
          setTimeout(blinkCursor, 100);
        } else {
          msgDiv.textContent = displayText;
          input.disabled = false;
          sendBtn.disabled = false;
          input.focus();
        }
      }
      blinkCursor();
    }
  }
  typeStep();
}

// Load chat history
function loadChatHistory() {
  if (!document.querySelector('#chat-history-container')) return;

  fetch('/chatbot/history/')
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('chat-history-container');

      if (data.sessions.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-sm px-3 py-2">No previous chats yet.</div>';
        return;
      }

      const historyHtml = data.sessions.map(session => {
        const date = new Date(session.updated_at);
        const dateStr = date.toLocaleDateString('en-GB'); // dd/mm/yyyy format
        const timeStr = date.toLocaleTimeString('en-GB', {
          hour: '2-digit',
          minute: '2-digit'
        });
        const title = `${dateStr} ${timeStr}`;

        return `
          <div class="chat-history-pill ${session.is_current ? 'active' : ''}"
               onclick="loadSession('${session.id}')">
            <div class="chat-title">${title}</div>
            <div class="chat-meta">${session.message_count} messages</div>
          </div>
        `;
      }).join('');

      container.innerHTML = historyHtml;
    })
    .catch(error => {
      console.error('Error loading chat history:', error);
      document.getElementById('chat-history-container').innerHTML =
        '<div class="text-red-500 text-sm px-3 py-2">Error loading history</div>';
    });
}

// Load a specific chat session
function loadSession(sessionId) {
  showThinking();

  fetch(`/chatbot/session/${sessionId}/`)
    .then(res => res.json())
    .then(data => {
      hideThinking();

      // Clear current messages
      document.getElementById('messages').innerHTML = '';

      // Load session messages
      data.messages.forEach(message => {
        if (message.message_type === 'property_results' && message.metadata.properties) {
          // Handle property results
          appendMessage(message.content, 'bot');
          message.metadata.properties.forEach(appendCard);
        } else {
          // Handle regular messages
          appendMessage(message.content, message.sender);
        }
      });

      // Update current session
      fetch('/chatbot/new-chat/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      }).then(() => {
        // Set the loaded session as current
        fetch(`/chatbot/session/${sessionId}/`).then(() => {
          loadChatHistory(); // Refresh history to show current session
        });
      });

      // Close sidebar on mobile
      if (window.innerWidth <= 768) {
        closeSidebar();
      }
    })
    .catch(error => {
      hideThinking();
      console.error('Error loading session:', error);
      appendMessage('Error loading chat session. Please try again.', 'bot');
    });
}

// Sidebar open/close
function openSidebar() {
  document.getElementById('tw-sidebar').classList.add('open');
  document.getElementById('sidebar-overlay').classList.add('open');
}
function closeSidebar() {
  document.getElementById('tw-sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}
document.getElementById('sidebar-overlay').onclick = closeSidebar;
// --- Start new chat (clear messages and input, show welcome) ---
function startNewChat() {
  showThinking();

  fetch('/chatbot/new-chat/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
    }
  })
  .then(res => res.json())
  .then(data => {
    hideThinking();
    document.getElementById('messages').innerHTML = '';
    document.getElementById('user-input').value = '';
    showWelcomeMessage();
    loadChatHistory(); // Refresh history
  })
  .catch(error => {
    hideThinking();
    console.error('Error starting new chat:', error);
  });
}

// Send message on Enter key
document.addEventListener('DOMContentLoaded', function() {
  showWelcomeMessage();

  // Load chat history for authenticated users
  if (isAuthenticated) {
    loadChatHistory();
  }

  const input = document.getElementById('user-input');
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !input.disabled) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Modal event listeners
  const modal = document.getElementById('properties-modal');

  // Close modal when clicking outside
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closePropertiesModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('show')) {
      closePropertiesModal();
    }
  });
});
</script>
</body>
</html>
