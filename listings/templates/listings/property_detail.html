{% extends 'base.html' %}
{% load static %}

{% block content %}
<div style="height: 35px;"></div>
<div class="container mt-4" >
  <!-- Desktop Heading (hidden on mobile) -->
  <h2 class="mb-4 d-none d-md-block">Property Details</h2>
  <!-- Mobile Heading (visible only on mobile) -->
  <h2 class="mb-4 d-block d-md-none" style="margin-top:-40px; margin-bottom:-5px;">Property Details</h2>
  <!-- ðŸ–¼ Mobile Image Gallery -->
  <div class="mobile-image-gallery d-md-none mb-3">
    <div class="gallery-scroll">
      <div class="gallery-card">
        <img src="{{ property.main_image.url }}" alt="Main Image" class="gallery-img" onclick="openLightbox(this.src)">
      </div>
      {% for image in interior_images %}
        <div class="gallery-card">
          <img src="{{ image.image.url }}" alt="Interior {{ forloop.counter }}" class="gallery-img" onclick="openLightbox(this.src)">
        </div>
      {% endfor %}
    </div>
  </div>
  <!-- Lightbox Overlay for Mobile Gallery -->
  <div id="mobileLightbox" class="mobile-lightbox-overlay" style="display: none;" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="Full Image" class="mobile-lightbox-img">
    <span class="mobile-lightbox-close">&times;</span>
  </div>
  <!-- Mobile Title & Location -->
  <div class="d-md-none mb-3 px-1">
    <h3 class="property-title-mobile mb-1">{{ property.title|title }}</h3>
    <div class="property-location-mobile mb-2">
      {% if property.street_address %}{{ property.street_address|title }}{% endif %}{% if property.suburb and property.suburb != property.city %}, {{ property.suburb|title }}{% endif %}{% if property.city %}, {{ property.city|title }}{% endif %}
    </div>
    <div class="property-icons-mobile d-flex gap-3 mb-3">
      <span class="icon-pill"><i class="fas fa-bed brand-orange"></i> {{ property.bedrooms }} Bedroom{{ property.bedrooms|pluralize }}</span>
      <span class="icon-pill"><i class="fas fa-bath brand-orange"></i> {{ property.bathrooms }} Bathroom{{ property.bathrooms|pluralize }}</span>
      <span class="icon-pill"><i class="fas fa-ruler-combined brand-orange"></i> {{ property.area }} mÂ²</span>
      {% if property.parking_spaces %}
        <span class="icon-pill"><i class="fas fa-car brand-orange"></i> {{ property.parking_spaces }} Parking</span>
      {% endif %}
    </div>
  </div>

  <!-- ðŸ–¼ Image Gallery -->
  <div class="row mb-4" style="height: clamp(300px, 50vh, 400px); overflow: hidden;">
    <div class="col-lg-8 col-md-12 h-100 pe-1 mb-2 mb-lg-0">
      <div class="h-100 rounded-start overflow-hidden">
        <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-img="{{ property.main_image.url }}">
          <img src="{{ property.main_image.url }}" alt="Main Image" class="img-fluid w-100 h-100" style="object-fit: cover;">
        </a>
      </div>
    </div>
    <div class="col-lg-4 col-md-12 h-100">
      <div class="row g-1 h-100 m-0">
        {% for image in interior_images %}
          {% if forloop.counter <= 3 %}
            <div class="col-6 p-0 h-50">
              <div class="h-100 pe-1 pb-1">
                <a href="#" class="d-block h-100 rounded overflow-hidden" data-bs-toggle="modal" data-bs-target="#imageModal" data-img="{{ image.image.url }}">
                  <img src="{{ image.image.url }}" class="img-fluid w-100 h-100" style="object-fit: cover;" alt="Interior Photo {{ forloop.counter }}">
                </a>
              </div>
            </div>
          {% elif forloop.counter == 4 %}
            <div class="col-6 p-0 h-50 position-relative">
              <div class="h-100 pe-1 pb-1">
                <a href="#" class="d-block h-100 rounded overflow-hidden position-relative" data-bs-toggle="modal" data-bs-target="#imageGalleryModal">
                  <img src="{{ image.image.url }}" class="img-fluid w-100 h-100" style="object-fit: cover;" alt="More Photos">
                  <div class="position-absolute bottom-0 end-0 m-2 px-3 py-1 bg-dark bg-opacity-75 text-white rounded">
                    Show More
                  </div>
                </a>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ðŸ”½ Property Info & Host Section -->
  <div class="row">
    <!-- Left Column -->
    <div class="col-lg-8 col-md-12 mb-4 mb-lg-0">
      <h3 class="text-truncate mb-2">{{ property.title }}</h3>
      <p class="text-muted mb-3">
        {% if property.street_address %}{{ property.street_address }}{% endif %}{% if property.suburb and property.suburb != property.city %}, {{ property.suburb }}{% endif %}{% if property.city %}, {{ property.city }}{% endif %}
      </p>

      <!-- Property Features Grid -->
      <div class="row g-2 mb-4">
        <div class="col-6 col-sm-3">
          <div class="border rounded p-3 text-center h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-bed fs-4 mb-2 text-primary"></i>
            <span class="small">{{ property.bedrooms }} Bedroom{{ property.bedrooms|pluralize }}</span>
          </div>
        </div>
        <div class="col-6 col-sm-3">
          <div class="border rounded p-3 text-center h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-bath fs-4 mb-2 text-primary"></i>
            <span class="small">{{ property.bathrooms }} Bathroom{{ property.bathrooms|pluralize }}</span>
          </div>
        </div>
        <div class="col-6 col-sm-3">
          <div class="border rounded p-3 text-center h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-ruler-combined fs-4 mb-2 text-primary"></i>
            <span class="small">{{ property.area }} mÂ²</span>
          </div>
        </div>
        {% if property.parking_spaces %}
          <div class="col-6 col-sm-3">
            <div class="border rounded p-3 text-center h-100 d-flex flex-column align-items-center justify-content-center">
              <i class="fas fa-car fs-4 mb-2 text-primary"></i>
              <span class="small">{{ property.parking_spaces }} Parking</span>
            </div>
          </div>
        {% endif %}
      </div>

      <h5 class="mb-3 section-heading">{{ property.property_type|title }} Description</h5>
      <p class="mb-4">{{ property.description }}</p>

      <!-- Amenities -->
      <h5 class="mb-3 section-heading">Offered Amenities</h5>
      <div class="amenities-container mb-3">
        {% for amenity in amenities %}
          <span class="amenity-item border rounded-pill px-3 py-2 bg-light d-flex align-items-center gap-2 {% if forloop.counter > 6 %}d-none{% endif %}">
            <i class="fas fa-{{ amenity.icon|default:'check' }} text-primary"></i>
            <span class="small">{{ amenity.name }}</span>
          </span>
        {% endfor %}
      </div>

      {% if amenities|length > 6 %}
        <button id="toggleAmenitiesBtn" class="btn btn-brand-accent mb-4">Show All Amenities ({{ amenities|length|add:"-6" }} more)</button>
      {% endif %}

      <!-- ðŸ—ºï¸ Map Section -->
      <h5 class="mb-3 section-heading">Property Location</h5>
      <div id="map" style="height: clamp(250px, 40vh, 350px);" class="rounded shadow-sm mb-4"></div>

      <!-- Get Directions Button -->
      {% if property.google_maps_directions_url %}
      <div class="mt-3 mb-4">
          <a href="{{ property.google_maps_directions_url }}" target="_blank" class="btn btn-brand-orange">
              <i class="fas fa-directions me-2"></i>
              Get Directions
          </a>
      </div>
      {% endif %}
    </div>

    <!-- Right Column -->
    <div class="col-lg-4 col-md-12">
      <!-- Host Information Card -->
      <div class="card mb-3 shadow-sm">
        <div class="card-body text-center">
          {% if property.owner.profile_photo and property.owner.profile_photo.url %}
            <img src="{{ property.owner.profile_photo.url }}" alt="Host" class="rounded-circle mb-3" style="width: clamp(60px, 12vw, 80px); height: clamp(60px, 12vw, 80px); object-fit: cover;">
          {% else %}
            <div class="text-muted small mb-3">No profile image</div>
          {% endif %}
          <p class="mb-1 small text-muted">Listed by:</p>
          <strong class="d-block mb-3">{{ property.owner.username }}</strong>
        </div>
      </div>

      <!-- Contact & Price Card -->
      <div class="card shadow-sm sticky-top" style="top: 90px;">
        <div class="card-body">
          <h4 class="mb-3"><span class="currency-black">{{ property.currency }} {{ property.price }}</span></h4>
          <hr>
          <button class="btn btn-brand-orange w-100 mb-3" onclick="toggleContactInfo()">Show Contact Details</button>
          <div id="contactInfo" class="d-none">
            <div class="mb-3">
              <strong class="d-block mb-1">Contact Email:</strong>
              <a href="mailto:{{ property.contact_email }}">{{ property.contact_email }}</a>
            </div>
            <div class="mb-0">
              <strong class="d-block mb-1">Phone:</strong>
              <a href="tel:{{ property.contact_phone }}">{{ property.contact_phone }}</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Single Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <img id="modalImage" src="" class="img-fluid rounded w-100">
      </div>
    </div>
  </div>
</div>

<!-- Gallery Modal -->
<div class="modal fade" id="imageGalleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Property Gallery</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6 col-lg-4">
            <img src="{{ property.main_image.url }}" class="img-fluid rounded" alt="Main Image">
          </div>
          {% for image in interior_images %}
            <div class="col-md-6 col-lg-4">
              <img src="{{ image.image.url }}" class="img-fluid rounded" alt="Interior {{ forloop.counter }}">
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  // Image preview
  document.querySelectorAll('[data-bs-target="#imageModal"]').forEach(img => {
    img.addEventListener('click', () => {
      document.getElementById('modalImage').src = img.getAttribute('data-img');
    });
  });

  // Toggle amenities
  document.getElementById('toggleAmenitiesBtn')?.addEventListener('click', function () {
    const amenities = document.querySelectorAll('.amenity-item');
    let showingAll = false;

    amenities.forEach((item, index) => {
      if (index >= 6) {
        item.classList.toggle('d-none');
        showingAll = !item.classList.contains('d-none');
      }
    });

    this.textContent = showingAll
      ? 'Show Fewer Amenities'
      : 'Show All Amenities ({{ amenities|length|add:"-6" }} more)';
  });

  // Toggle contact information
  function toggleContactInfo() {
    const contactInfo = document.getElementById('contactInfo');
    const button = document.querySelector('button[onclick="toggleContactInfo()"]');

    if (contactInfo.classList.contains('d-none')) {
      contactInfo.classList.remove('d-none');
      button.textContent = 'Hide Contact Details';
    } else {
      contactInfo.classList.add('d-none');
      button.textContent = 'Show Contact Details';
    }
  }

  // Lightbox for mobile gallery
  function openLightbox(src) {
    var overlay = document.getElementById('mobileLightbox');
    var img = document.getElementById('lightboxImg');
    overlay.style.display = 'flex'; // Show overlay
    overlay.classList.add('show');
    img.src = src;
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    var overlay = document.getElementById('mobileLightbox');
    overlay.style.display = 'none'; // Hide overlay
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
</script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

{{ property.location.y|json_script:"lat" }}
{{ property.location.x|json_script:"lng" }}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const lat = JSON.parse(document.getElementById('lat').textContent);
    const lng = JSON.parse(document.getElementById('lng').textContent);

    // Ensure lightbox is hidden on page load
    document.getElementById('mobileLightbox')?.classList.remove('show');

    if (lat && lng) {
      const map = L.map('map').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© OpenStreetMap contributors'
      }).addTo(map);

      L.marker([lat, lng]).addTo(map)
        .bindPopup(`<b>{{ property.title|escapejs }}</b><br><a href="{{ property.google_maps_directions_url }}" target="_blank">Get Directions</a>`)
        .openPopup();
    } else {
      document.getElementById('map').innerHTML = "<div class='d-flex align-items-center justify-content-center h-100'><p class='text-muted mb-0'>Location not available.</p></div>";
    }
  });
</script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
  .amenities-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .amenity-item {
    transition: all 0.3s ease;
  }

  .amenity-item:hover {
    background-color: var(--brick-orange) !important;
    color: white !important;
    transform: translateY(-1px);
  }

  /* Responsive adjustments */
  @media (max-width: 576px) {
    .container {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    .amenities-container {
      gap: 0.25rem;
    }

    .amenity-item {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem !important;
    }

    .sticky-top {
      position: relative !important;
      top: 0 !important;
    }
  }

  @media (min-width: 577px) and (max-width: 768px) {
    .amenity-item {
      font-size: 0.875rem;
    }
  }

  @media (min-width: 769px) {
    .sticky-top {
      top: 1rem !important;
    }
  }

  /* Ensure proper spacing on mobile */
  .row.g-2 > div {
    margin-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    .row.g-2 > div {
      margin-bottom: 0.75rem;
    }
  }

  .brand-orange { color: #c15a2e !important; }
  .btn-brand-orange {
    background: #c15a2e;
    color: #fff !important;
    border: 2px solid #c15a2e;
    border-radius: 50px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
  }
  .btn-brand-orange:hover, .btn-brand-orange:focus {
    background: #a84b24;
    color: #fff !important;
    border-color: #a84b24;
  }
  .btn-brand-accent {
    background: #e4d3b2;
    color: #2f2f2f !important;
    border: 2px solid #e4d3b2;
    border-radius: 50px;
    font-weight: 600;
    transition: background 0.2s, color 0.2s;
  }
  .btn-brand-accent:hover, .btn-brand-accent:focus {
    background: #c15a2e;
    color: #fff !important;
    border-color: #c15a2e;
  }
  @media (max-width: 768px) {
    .mobile-image-gallery {
      width: 100vw;
      margin-left: -16px;
      margin-right: -16px;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }
    .gallery-scroll {
      display: flex;
      flex-direction: row;
      gap: 1.1rem;
      overflow-x: auto;
      padding: 0.5rem 1.2rem 0.5rem 1.2rem;
      scroll-snap-type: x mandatory;
    }
    .gallery-card {
      flex: 0 0 auto;
      width: 240px;
      height: 240px;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(193,90,46,0.08);
      background: #fff;
      scroll-snap-align: start;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gallery-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 18px;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .gallery-img:active {
      transform: scale(0.97);
    }
    .mobile-lightbox-overlay {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.2s;
    }
    .mobile-lightbox-overlay.show {
      display: flex;
    }
    .mobile-lightbox-img {
      max-width: 92vw;
      max-height: 80vh;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
      background: #fff;
    }
    .mobile-lightbox-close {
      position: absolute;
      top: 1.2rem;
      right: 2rem;
      font-size: 2.5rem;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      z-index: 2100;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .property-title-mobile {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2f2f2f;
      text-transform: capitalize;
      margin-bottom: 0.2rem;
    }
    .property-location-mobile {
      font-size: 1rem;
      color: #7a6a5a;
      text-transform: capitalize;
      margin-bottom: 0.2rem;
    }
    .property-icons-mobile {
      font-size: 0.95rem;
      color: #c15a2e;
      flex-wrap: wrap;
      gap: 0.7rem;
    }
    .icon-pill {
      background: #f3ecdf;
      border-radius: 16px;
      padding: 0.3rem 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 500;
      color: #c15a2e;
      font-size: 0.95rem;
    }
    /* Hide original gallery and info on mobile */
    .row.mb-4, .row > .col-lg-8 > h3, .row > .col-lg-8 > p.text-muted, .row > .col-lg-8 > .row.g-2 { display: none !important; }
    /* Brand color for amenities button */
    #toggleAmenitiesBtn {
      background: #e4d3b2;
      color: #2f2f2f;
      border: 2px solid #e4d3b2;
      border-radius: 50px;
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
      font-size: 0.85rem;
      padding: 0.35rem 1.1rem;
      min-height: 32px;
      line-height: 1.1;
    }
    #toggleAmenitiesBtn:hover, #toggleAmenitiesBtn:focus {
      background: #c15a2e;
      color: #fff;
      border-color: #c15a2e;
    }
    /* Brand color for contact button */
    .btn-contact-mobile {
      background: #c15a2e;
      color: #fff !important;
      border: 2px solid #c15a2e;
      border-radius: 50px;
      font-weight: 600;
      width: 100%;
      margin-bottom: 1rem;
      transition: background 0.2s, color 0.2s;
    }
    .btn-contact-mobile:hover, .btn-contact-mobile:focus {
      background: #a84b24;
      color: #fff !important;
      border-color: #a84b24;
    }
  }

  .currency-black {
    color: #2f2f2f !important;
    font-weight: 600;
  }

  .section-heading {
    font-size: 1.15rem;
    font-weight: 700;
    color: #2f2f2f;
    margin-bottom: 0.7rem;
    letter-spacing: 0.01em;
  }
  .header, .navbar {
    z-index: 1050;
  }
  .sticky-top {
    z-index: 1040;
  }
</style>
{% endblock %}
