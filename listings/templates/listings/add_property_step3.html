{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm" style="background-color: #f9f5ef; border: 1px solid #e4d3b2;">
        <div class="card-body">
          <h2 class="card-title mb-4" style="color: #2f2f2f;">Step 3: Property Location</h2>

          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label for="city_suburb" class="form-label fw-medium" style="color: #2f2f2f;">City & Suburb</label>
              <input type="text" id="city_suburb" name="city_suburb" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="e.g. Ashdown Park, Harare" autocomplete="off" value="{{ form.city_suburb.value|default:'' }}">
              <div id="city_suburb_suggestions" class="location-suggestions"></div>
              {% if form.city_suburb.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.city_suburb.errors|first }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="street_address" class="form-label fw-medium" style="color: #2f2f2f;">Street Address</label>
              <input type="text" id="street_address" name="street_address" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="e.g. 123 Smart Street" autocomplete="off" value="{{ form.street_address.value|default:'' }}">
              <div id="street_address_suggestions" class="location-suggestions"></div>
              {% if form.street_address.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.street_address.errors|first }}</div>
              {% endif %}
            </div>

            <input type="hidden" id="latitude" name="latitude" value="{{ form.latitude.value|default:'' }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ form.longitude.value|default:'' }}">
            <input type="hidden" id="google_maps_url" name="google_maps_url" value="{{ form.google_maps_url.value|default:'' }}">

            <div id="map" class="mb-4"></div>

            <div class="mb-3">
              <button type="button" id="confirm-location-btn" class="btn btn-primary">Confirm Location</button>
              <span id="confirm-location-prompt" class="ms-2 text-success" style="display:none;">Location confirmed!</span>
            </div>

            <div class="d-flex justify-content-between">
              <a href="{% url 'add_property_step2' %}" class="btn rounded-3" style="border-color: #e4d3b2; color: #c15a2e;">
                <i class="fas fa-arrow-left me-1"></i> Back
              </a>
              <button type="submit" class="btn rounded-3" style="background-color: #c15a2e; color: white;">
                Next <i class="fas fa-arrow-right ms-1"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Google Maps JS API (Places + Geocoding) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&libraries=places"></script>
<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Default map center (Harare)
    let defaultLat = -17.8252, defaultLng = 31.0335;
    let latInput = document.getElementById("latitude");
    let lngInput = document.getElementById("longitude");
    let citySuburbInput = document.getElementById('city_suburb');
    let citySuburbSuggestions = document.getElementById('city_suburb_suggestions');
    let autocompleteService = new google.maps.places.AutocompleteService();
    let geocoder = new google.maps.Geocoder();
    let cityPredictions = [];
    let selectedIndex = -1;

    // Use existing values if editing
    let startLat = latInput.value ? parseFloat(latInput.value) : defaultLat;
    let startLng = lngInput.value ? parseFloat(lngInput.value) : defaultLng;

    // Initialize map
    let map = L.map('map').setView([startLat, startLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add marker (draggable)
    let marker = L.marker([startLat, startLng], {draggable: true}).addTo(map);

    // Update hidden fields when marker is dragged
    marker.on('dragend', function (e) {
        let pos = marker.getLatLng();
        latInput.value = pos.lat;
        lngInput.value = pos.lng;
    });

    // Allow user to click map to move marker
    map.on('click', function (e) {
        marker.setLatLng(e.latlng);
        latInput.value = e.latlng.lat;
        lngInput.value = e.latlng.lng;
    });

    // Custom city/suburb suggestion box using Google AutocompleteService (Zimbabwe only)
    citySuburbInput.addEventListener('input', function() {
        const query = citySuburbInput.value.trim();
        citySuburbSuggestions.innerHTML = '';
        citySuburbSuggestions.style.display = 'none';
        cityPredictions = [];
        selectedIndex = -1;
        if (query.length < 2) return;
        autocompleteService.getPlacePredictions({
            input: query,
            {#types: ['geocode'],#}
            componentRestrictions: { country: 'ZW' }
        }, function(preds, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK && preds && preds.length) {
                cityPredictions = preds;
                citySuburbSuggestions.style.display = 'block';
                citySuburbSuggestions.innerHTML = '';
                cityPredictions.forEach((pred, idx) => {
                    const item = document.createElement('div');
                    item.classList.add('suggestion-item');
                    item.textContent = pred.description;
                    item.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        selectCityPrediction(idx);
                    });
                    citySuburbSuggestions.appendChild(item);
                });
            }
        });
    });

    citySuburbInput.addEventListener('keydown', function(e) {
        if (!cityPredictions.length) return;
        if (e.key === 'ArrowDown') {
            selectedIndex = (selectedIndex + 1) % cityPredictions.length;
            updateSelection();
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            selectedIndex = (selectedIndex - 1 + cityPredictions.length) % cityPredictions.length;
            updateSelection();
            e.preventDefault();
        } else if (e.key === 'Enter') {
            if (selectedIndex >= 0 && selectedIndex < cityPredictions.length) {
                selectCityPrediction(selectedIndex);
                e.preventDefault();
            }
        }
    });

    function updateSelection() {
        const items = citySuburbSuggestions.querySelectorAll('.suggestion-item');
        items.forEach((item, idx) => {
            if (idx === selectedIndex) {
                item.classList.add('active');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('active');
            }
        });
    }

    function selectCityPrediction(idx) {
        const pred = cityPredictions[idx];
        if (!pred) return;
        citySuburbInput.value = pred.description;
        citySuburbSuggestions.style.display = 'none';
        geocoder.geocode({ placeId: pred.place_id }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const loc = results[0].geometry.location;
                const lat = loc.lat(), lng = loc.lng();
                marker.setLatLng([lat, lng]);
                map.setView([lat, lng], 14);
                latInput.value = lat;
                lngInput.value = lng;
            }
        });
    }

    document.addEventListener('click', function(e) {
        if (!citySuburbSuggestions.contains(e.target) && e.target !== citySuburbInput) {
            citySuburbSuggestions.style.display = 'none';
        }
    });

    // Google Places Autocomplete for street address (Zimbabwe only)
    let autocomplete = new google.maps.places.Autocomplete(
        document.getElementById('street_address'),
        { types: ['address'], componentRestrictions: { country: 'ZW' } }
    );
    autocomplete.addListener('place_changed', function () {
        let place = autocomplete.getPlace();
        if (!place.geometry) return;
        let lat = place.geometry.location.lat();
        let lng = place.geometry.location.lng();
        // Move marker and map
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 16);
        // Update hidden fields
        latInput.value = lat;
        lngInput.value = lng;
    });

    // Confirm Location button logic
    const confirmBtn = document.getElementById('confirm-location-btn');
    const confirmPrompt = document.getElementById('confirm-location-prompt');
    const streetInput = document.getElementById('street_address');

    confirmBtn.addEventListener('click', function() {
        if (latInput.value && lngInput.value) {
            confirmPrompt.style.display = 'inline';
            confirmPrompt.textContent = 'Location confirmed!';
            citySuburbInput.readOnly = true;
            streetInput.readOnly = true;
            confirmBtn.disabled = true;
            // Make the marker non-draggable after confirmation
            if (marker) {
                marker.dragging.disable();
            }
            // Optionally, disable map click
            map.off('click');
        } else {
            confirmPrompt.style.display = 'inline';
            confirmPrompt.textContent = 'Please select a valid location first';
            confirmPrompt.classList.remove('text-success');
            confirmPrompt.classList.add('text-danger');
        }
    });
});
</script>

<style>
  .card {
    border-radius: 12px;
  }
  .form-control {
    transition: all 0.2s ease;
  }
  .btn {
    transition: all 0.2s ease;
    padding: 8px 16px;
  }
  .btn:hover {
    background-color: #a84b24 !important;
    color: white !important;
  }
  #map {
    height: 340px;
    min-height: 220px;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    width: 100%;
    max-width: 100%;
    position: relative;
    z-index: 1;
  }
  @media (max-width: 768px) {
    #map {
      height: 220px;
      min-height: 140px;
      width: 100%;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
      border-radius: 0.5rem;
    }
  }
  .leaflet-container {
    background-color: #f9f5ef !important;
    border-radius: 10px;
  }
  .leaflet-popup-content a {
    color: #c15a2e !important;
  }
  .custom-div-icon {
    background: none;
    border: none;
  }

  /* Updated Autocomplete suggestions styling */
  .location-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e4d3b2;
    border-top: none;
    border-radius: 0 0 12px 12px;
    max-height: 260px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    margin-top: -2px;
  }

  /* Add relative positioning to the parent div of each input */
  .mb-3 {
    position: relative;
  }

  .suggestion-item {
    padding: 0.75rem 1.25rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s ease;
    font-size: 1rem;
  }
  .suggestion-item:last-child {
    border-bottom: none;
  }
  .suggestion-item:hover, .suggestion-item.active {
    background: #f9f5ef;
    color: #c15a2e;
  }
  .highlight {
    background: #ffe5d0;
    color: #c15a2e;
    font-weight: bold;
    border-radius: 3px;
    padding: 0 2px;
  }
</style>
{% endblock %}