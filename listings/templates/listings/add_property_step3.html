{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm" style="background-color: #f9f5ef; border: 1px solid #e4d3b2;">
        <div class="card-body">
          <h2 class="card-title mb-4" style="color: #2f2f2f;">Step 3: Property Location</h2>

          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label for="city-autocomplete" class="form-label fw-medium" style="color: #2f2f2f;">City</label>
              <input type="text" id="city-autocomplete" name="city" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="Start typing city..." autocomplete="off" value="{{ form.city.value|default:'' }}">
              {% if form.city.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.city.errors|first }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="suburb-autocomplete" class="form-label fw-medium" style="color: #2f2f2f;">Suburb (optional)</label>
              <input type="text" id="suburb-autocomplete" name="suburb" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="Start typing suburb..." autocomplete="off" value="{{ form.suburb.value|default:'' }}">
              {% if form.suburb.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.suburb.errors|first }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="street-autocomplete" class="form-label fw-medium" style="color: #2f2f2f;">Street Address</label>
              <input type="text" id="street-autocomplete" name="street_address" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="Start typing street address..." autocomplete="off" value="{{ form.street_address.value|default:'' }}">
              {% if form.street_address.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.street_address.errors|first }}</div>
              {% endif %}
            </div>

            <!-- Confirm Location Button and Prompt -->
            <div class="mb-3">
              <button type="button" class="btn rounded-3" id="confirm-location-btn" style="border-color: #e4d3b2; color: #c15a2e;">
                ✅ Confirm Location
              </button>
              <div id="confirm-location-prompt" class="mt-2" style="color: #c15a2e; font-size: 1rem; display: none;">
                Please confirm if this is the correct location displayed above.
              </div>
            </div>

            <!-- Hidden Lat/Lng Fields -->
            <input type="hidden" id="id_latitude" name="latitude" value="{{ form.latitude.value|default:'' }}">
            <input type="hidden" id="id_longitude" name="longitude" value="{{ form.longitude.value|default:'' }}">

            <!-- Map Container -->
            <div id="map" style="height: 400px; border-radius: 12px; border: 1px solid #e4d3b2;" class="mb-4"></div>

            <div class="d-flex justify-content-between">
              <a href="{% url 'add_property_step2' %}" class="btn rounded-3" style="border-color: #e4d3b2; color: #c15a2e;">
                <i class="fas fa-arrow-left me-1"></i> Back
              </a>
              <button type="submit" class="btn rounded-3" style="background-color: #c15a2e; color: white;">
                Next <i class="fas fa-arrow-right ms-1"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Google Maps JS API (Places + Geocoding) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&libraries=places"></script>
<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  let map = L.map('map').setView([-17.8252, 31.0335], 13); // Harare default
  let marker;
  let confirmed = false;

  // Custom marker icon
  const customIcon = L.icon({
    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
    shadowSize: [41, 41]
  });

  // Add OSM tiles for Leaflet
  map.attributionControl.setPrefix('');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data © <a href="https://openstreetmap.org" style="color: #c15a2e;">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Google Places Autocomplete for City
  const cityInput = document.getElementById('city-autocomplete');
  const suburbInput = document.getElementById('suburb-autocomplete');
  const streetInput = document.getElementById('street-autocomplete');
  const latInput = document.getElementById('id_latitude');
  const lngInput = document.getElementById('id_longitude');
  const confirmBtn = document.getElementById('confirm-location-btn');
  const confirmPrompt = document.getElementById('confirm-location-prompt');

  let cityPlace = null;
  let suburbPlace = null;
  let streetPlace = null;

  // Helper: Geocode full address and update map
  function geocodeAndUpdateMap() {
    if (!cityInput.value) return;
    let address = cityInput.value;
    if (suburbInput.value) address = suburbInput.value + ', ' + address;
    if (streetInput.value) address = streetInput.value + ', ' + address;
    address += ', Zimbabwe';
    const apiKey = "{{ GOOGLE_API_KEY|default:'' }}";
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.status === 'OK' && data.results.length > 0) {
          const lat = data.results[0].geometry.location.lat;
          const lng = data.results[0].geometry.location.lng;
          if (marker) {
            marker.setLatLng([lat, lng]);
          } else {
            marker = L.marker([lat, lng], {
              draggable: true,
              icon: customIcon
            }).addTo(map);
            marker.on("dragend", function() {
              const pos = marker.getLatLng();
              latInput.value = pos.lat;
              lngInput.value = pos.lng;
            });
          }
          map.setView([lat, lng], 15);
          latInput.value = lat;
          lngInput.value = lng;
        }
      });
  }

  // Google Places Autocomplete for City
  const cityAutocomplete = new google.maps.places.Autocomplete(cityInput, {
    types: ['(cities)'],
    componentRestrictions: { country: 'zw' }
  });
  cityAutocomplete.addListener('place_changed', function() {
    const place = cityAutocomplete.getPlace();
    cityPlace = place;
    // Extract city (locality)
    let city = '';
    if (place.address_components) {
      for (const comp of place.address_components) {
        if (comp.types.includes('locality')) city = comp.long_name;
      }
    }
    cityInput.value = city;
    suburbInput.value = '';
    streetInput.value = '';
    geocodeAndUpdateMap();
  });
  cityInput.addEventListener('input', function() {
    suburbInput.value = '';
    streetInput.value = '';
    geocodeAndUpdateMap();
  });

  // Google Places Autocomplete for Suburb (neighborhood)
  const suburbAutocomplete = new google.maps.places.Autocomplete(suburbInput, {
    types: ['geocode'],
    componentRestrictions: { country: 'zw' }
  });
  suburbAutocomplete.addListener('place_changed', function() {
    const place = suburbAutocomplete.getPlace();
    suburbPlace = place;
    // Extract suburb (sublocality_level_1 or neighborhood)
    let suburb = '';
    if (place.address_components) {
      for (const comp of place.address_components) {
        if (comp.types.includes('sublocality_level_1')) suburb = comp.long_name;
        else if (comp.types.includes('neighborhood') && !suburb) suburb = comp.long_name;
      }
    }
    suburbInput.value = suburb;
    geocodeAndUpdateMap();
  });
  suburbInput.addEventListener('input', function() {
    geocodeAndUpdateMap();
  });

  // Google Places Autocomplete for Street Address
  const streetAutocomplete = new google.maps.places.Autocomplete(streetInput, {
    types: ['address'],
    componentRestrictions: { country: 'zw' }
  });
  streetAutocomplete.addListener('place_changed', function() {
    const place = streetAutocomplete.getPlace();
    streetPlace = place;
    // Extract street_number + route
    let street = '';
    let number = '';
    if (place.address_components) {
      for (const comp of place.address_components) {
        if (comp.types.includes('street_number')) number = comp.long_name;
        if (comp.types.includes('route')) street = comp.long_name;
      }
    }
    let fullStreet = number ? number + ' ' + street : street;
    streetInput.value = fullStreet.trim();
    geocodeAndUpdateMap();
  });
  streetInput.addEventListener('input', function() {
    geocodeAndUpdateMap();
  });

  // Confirm Location button logic
  confirmBtn.addEventListener('click', function() {
    if (latInput.value && lngInput.value) {
      confirmed = true;
      confirmPrompt.style.display = 'block';
      confirmPrompt.textContent = 'Location confirmed! These coordinates will be submitted.';
      cityInput.readOnly = true;
      suburbInput.readOnly = true;
      streetInput.readOnly = true;
      confirmBtn.disabled = true;
      if (marker) marker.dragging.disable();
    } else {
      confirmPrompt.style.display = 'block';
      confirmPrompt.textContent = 'Please select a valid location before confirming.';
    }
  });

  // Style form inputs on focus
  document.querySelectorAll('.form-control').forEach(input => {
    input.addEventListener('focus', function() {
      this.style.borderColor = '#c15a2e';
      this.style.boxShadow = '0 0 0 0.25rem rgba(193, 90, 46, 0.15)';
    });
    input.addEventListener('blur', function() {
      this.style.borderColor = '#e4d3b2';
      this.style.boxShadow = 'none';
    });
  });
</script>

<style>
  .card {
    border-radius: 12px;
  }

  .form-control {
    transition: all 0.2s ease;
  }

  .btn {
    transition: all 0.2s ease;
    padding: 8px 16px;
  }

  .btn:hover {
    background-color: #a84b24 !important;
    color: white !important;
  }

  .leaflet-container {
    background-color: #f9f5ef !important;
  }

  .leaflet-popup-content a {
    color: #c15a2e !important;
  }
</style>
{% endblock %}