{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm" style="background-color: #f9f5ef; border: 1px solid #e4d3b2;">
        <div class="card-body">
          <h2 class="card-title mb-4" style="color: #2f2f2f;">Step 3: Property Location</h2>

          <form method="post">
            {% csrf_token %}

            <div class="mb-3">
              <label for="city_suburb" class="form-label fw-medium" style="color: #2f2f2f;">City & Suburb</label>
              <input type="text" id="city_suburb" name="city_suburb" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="e.g. Ashdown Park, Harare" autocomplete="off" value="{{ form.city_suburb.value|default:'' }}">
              <div id="city_suburb_suggestions" class="location-suggestions"></div>
              {% if form.city_suburb.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.city_suburb.errors|first }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="street_address" class="form-label fw-medium" style="color: #2f2f2f;">Street Address</label>
              <input type="text" id="street_address" name="street_address" class="form-control rounded-3" style="background-color: white; border-color: #e4d3b2;" placeholder="e.g. 123 Smart Street" autocomplete="off" value="{{ form.street_address.value|default:'' }}">
              <div id="street_address_suggestions" class="location-suggestions"></div>
              {% if form.street_address.errors %}
                <div class="invalid-feedback d-block" style="color: #c15a2e;">{{ form.street_address.errors|first }}</div>
              {% endif %}
            </div>

            <input type="hidden" id="latitude" name="latitude" value="{{ form.latitude.value|default:'' }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ form.longitude.value|default:'' }}">
            <input type="hidden" id="google_maps_url" name="google_maps_url" value="{{ form.google_maps_url.value|default:'' }}">

            <div id="map" class="mb-4"></div>

            <div class="mb-3">
              <button type="button" class="btn rounded-3" id="confirm-location-btn" style="border-color: #e4d3b2; color: #c15a2e;">
                âœ… Confirm Location
              </button>
              <div id="confirm-location-prompt" class="mt-2" style="color: #c15a2e; font-size: 1rem; display: none;">
                Please confirm if this is the correct location displayed above.
              </div>
            </div>

            <div class="d-flex justify-content-between">
              <a href="{% url 'add_property_step2' %}" class="btn rounded-3" style="border-color: #e4d3b2; color: #c15a2e;">
                <i class="fas fa-arrow-left me-1"></i> Back
              </a>
              <button type="submit" class="btn rounded-3" style="background-color: #c15a2e; color: white;">
                Next <i class="fas fa-arrow-right ms-1"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Google Maps JS API (Places + Geocoding) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_API_KEY }}&libraries=places"></script>
<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  let map = L.map('map', { zoomControl: false }).setView([-17.8252, 31.0335], 13); // Harare default
  let marker;
  let confirmed = false;

  // Use OpenStreetMap tile layer
  map.attributionControl.setPrefix('');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Add zoom control bottom right
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  // Google-style marker using FontAwesome
  const customIcon = L.divIcon({
    html: '<i class="fas fa-map-marker-alt fa-2x" style="color: #c15a2e; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));"></i>',
    iconSize: [28, 36],
    iconAnchor: [14, 36],
    className: 'custom-div-icon'
  });

  // Input elements
  let citySuburbInput = document.getElementById("city_suburb");
  let streetInput = document.getElementById("street_address");
  let latInput = document.getElementById("latitude");
  let lngInput = document.getElementById("longitude");
  let mapsUrlInput = document.getElementById("google_maps_url");
  let confirmBtn = document.getElementById("confirm-location-btn");
  let confirmPrompt = document.getElementById("confirm-location-prompt");

  // Suggestions boxes
  let citySuburbSuggestions = document.getElementById("city_suburb_suggestions");
  let streetSuggestions = document.getElementById("street_address_suggestions");

  // Initialize autocomplete services
  let autocompleteService = new google.maps.places.AutocompleteService();
  let placesService = new google.maps.places.PlacesService(document.createElement('div'));
  let citySuburbPredictions = [];
  let streetPredictions = [];
  let citySuburbSelectedIndex = -1;
  let streetSelectedIndex = -1;

  // Highlight matching text in suggestions
  function highlightMatch(text, query) {
    const re = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'ig');
    return text.replace(re, '<span class="highlight">$1</span>');
  }

  // Setup autocomplete for city & suburb input
  citySuburbInput.addEventListener('input', function() {
    const query = citySuburbInput.value.trim();
    citySuburbSuggestions.innerHTML = '';
    citySuburbSuggestions.style.display = 'none';
    citySuburbPredictions = [];
    citySuburbSelectedIndex = -1;

    if (query.length < 2) return;

    autocompleteService.getPlacePredictions({
      input: query,
      types: ['geocode'],
      componentRestrictions: { country: 'ZW' }
    }, function(preds, status) {
      if (status === google.maps.places.PlacesServiceStatus.OK && preds && preds.length) {
        citySuburbPredictions = preds;
        citySuburbSuggestions.style.display = 'block';
        citySuburbSuggestions.innerHTML = '';

        citySuburbPredictions.forEach((pred, idx) => {
          const item = document.createElement('div');
          item.classList.add('suggestion-item');
          item.innerHTML = highlightMatch(pred.description, query);
          item.addEventListener('mousedown', function(e) {
            e.preventDefault();
            selectCitySuburbPrediction(idx);
          });
          citySuburbSuggestions.appendChild(item);
        });
      } else {
        citySuburbSuggestions.style.display = 'none';
      }
    });
  });

  // Setup autocomplete for street address input
  streetInput.addEventListener('input', function() {
    const query = streetInput.value.trim();
    streetSuggestions.innerHTML = '';
    streetSuggestions.style.display = 'none';
    streetPredictions = [];
    streetSelectedIndex = -1;

    if (query.length < 2) return;

    autocompleteService.getPlacePredictions({
      input: query,
      types: ['address'],
      componentRestrictions: { country: 'ZW' }
    }, function(preds, status) {
      if (status === google.maps.places.PlacesServiceStatus.OK && preds && preds.length) {
        streetPredictions = preds;
        streetSuggestions.style.display = 'block';
        streetSuggestions.innerHTML = '';

        streetPredictions.forEach((pred, idx) => {
          const item = document.createElement('div');
          item.classList.add('suggestion-item');
          item.innerHTML = highlightMatch(pred.description, query);
          item.addEventListener('mousedown', function(e) {
            e.preventDefault();
            selectStreetPrediction(idx);
          });
          streetSuggestions.appendChild(item);
        });
      } else {
        streetSuggestions.style.display = 'none';
      }
    });
  });

  // Keyboard navigation for city & suburb suggestions
  citySuburbInput.addEventListener('keydown', function(e) {
    if (!citySuburbPredictions.length) return;

    if (e.key === 'ArrowDown') {
      citySuburbSelectedIndex = (citySuburbSelectedIndex + 1) % citySuburbPredictions.length;
      updateCitySuburbSelection();
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      citySuburbSelectedIndex = (citySuburbSelectedIndex - 1 + citySuburbPredictions.length) % citySuburbPredictions.length;
      updateCitySuburbSelection();
      e.preventDefault();
    } else if (e.key === 'Enter') {
      if (citySuburbSelectedIndex >= 0 && citySuburbSelectedIndex < citySuburbPredictions.length) {
        selectCitySuburbPrediction(citySuburbSelectedIndex);
        e.preventDefault();
      }
    }
  });

  // Keyboard navigation for street address suggestions
  streetInput.addEventListener('keydown', function(e) {
    if (!streetPredictions.length) return;

    if (e.key === 'ArrowDown') {
      streetSelectedIndex = (streetSelectedIndex + 1) % streetPredictions.length;
      updateStreetSelection();
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      streetSelectedIndex = (streetSelectedIndex - 1 + streetPredictions.length) % streetPredictions.length;
      updateStreetSelection();
      e.preventDefault();
    } else if (e.key === 'Enter') {
      if (streetSelectedIndex >= 0 && streetSelectedIndex < streetPredictions.length) {
        selectStreetPrediction(streetSelectedIndex);
        e.preventDefault();
      }
    }
  });

  // Update selected suggestion for city & suburb
  function updateCitySuburbSelection() {
    const items = citySuburbSuggestions.querySelectorAll('.suggestion-item');
    items.forEach((item, idx) => {
      if (idx === citySuburbSelectedIndex) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  }

  // Update selected suggestion for street address
  function updateStreetSelection() {
    const items = streetSuggestions.querySelectorAll('.suggestion-item');
    items.forEach((item, idx) => {
      if (idx === streetSelectedIndex) {
        item.classList.add('active');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('active');
      }
    });
  }

  // Select a city & suburb prediction
  function selectCitySuburbPrediction(idx) {
    const pred = citySuburbPredictions[idx];
    if (!pred) return;

    citySuburbInput.value = pred.description;
    citySuburbSuggestions.style.display = 'none';
    geocodeAndUpdateMap();
  }

  // Select a street address prediction
  function selectStreetPrediction(idx) {
    const pred = streetPredictions[idx];
    if (!pred) return;

    streetInput.value = pred.description;
    streetSuggestions.style.display = 'none';
    geocodeAndUpdateMap();
  }

  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (!citySuburbSuggestions.contains(e.target) && e.target !== citySuburbInput) {
      citySuburbSuggestions.style.display = 'none';
    }
    if (!streetSuggestions.contains(e.target) && e.target !== streetInput) {
      streetSuggestions.style.display = 'none';
    }
  });

  // --- Real-time geocode and map update ---
  function geocodeAndUpdateMap() {
    let address = '';
    if (streetInput.value) address += streetInput.value + ', ';
    if (citySuburbInput.value) address += citySuburbInput.value + ', ';
    address += 'Zimbabwe';
    const apiKey = "{{ GOOGLE_API_KEY|default:'' }}";
    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.status === 'OK' && data.results.length > 0) {
          const lat = data.results[0].geometry.location.lat;
          const lng = data.results[0].geometry.location.lng;
          latInput.value = lat;
          lngInput.value = lng;
          updateMapMarker(lat, lng);
        }
      });
  }

  // --- Update Leaflet marker in real time ---
  function updateMapMarker(lat, lng) {
    if (marker) {
      marker.setLatLng([lat, lng]);
    } else {
      marker = L.marker([lat, lng], {
        draggable: true,
        icon: customIcon
      }).addTo(map);
      marker.on("dragend", function() {
        const pos = marker.getLatLng();
        latInput.value = pos.lat;
        lngInput.value = pos.lng;
      });
    }
    map.setView([lat, lng], 16, { animate: true });
  }

  // --- Confirm Location button logic ---
  confirmBtn.addEventListener('click', function() {
    if (latInput.value && lngInput.value) {
      const url = `https://www.google.com/maps?q=${latInput.value},${lngInput.value}`;
      mapsUrlInput.value = url;
      confirmPrompt.style.display = 'block';
      confirmPrompt.textContent = 'Location confirmed!';
      citySuburbInput.readOnly = true;
      streetInput.readOnly = true;
      confirmBtn.disabled = true;
    }
  });

  // Style form inputs on focus
  document.querySelectorAll('.form-control').forEach(input => {
    input.addEventListener('focus', function() {
      this.style.borderColor = '#c15a2e';
      this.style.boxShadow = '0 0 0 0.25rem rgba(193, 90, 46, 0.15)';
    });
    input.addEventListener('blur', function() {
      this.style.borderColor = '#e4d3b2';
      this.style.boxShadow = 'none';
    });
  });
</script>

<style>
  .card {
    border-radius: 12px;
  }
  .form-control {
    transition: all 0.2s ease;
  }
  .btn {
    transition: all 0.2s ease;
    padding: 8px 16px;
  }
  .btn:hover {
    background-color: #a84b24 !important;
    color: white !important;
  }
  #map {
    height: 340px;
    min-height: 220px;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    width: 100%;
    max-width: 100%;
  }
  @media (max-width: 768px) {
    #map {
      height: 220px;
      min-height: 140px;
      width: 100vw;
      max-width: 100vw;
      margin-left: -16px;
      margin-right: -16px;
      border-radius: 0.5rem;
    }
  }
  .leaflet-container {
    background-color: #f9f5ef !important;
    border-radius: 10px;
  }
  .leaflet-popup-content a {
    color: #c15a2e !important;
  }
  .custom-div-icon {
    background: none;
    border: none;
  }

  /* Autocomplete suggestions styling */
  .location-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #e4d3b2;
    border-top: none;
    border-radius: 0 0 12px 12px;
    max-height: 260px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 16px rgba(0,0,0,0.10);
  }
  .suggestion-item {
    padding: 0.75rem 1.25rem;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s ease;
    font-size: 1rem;
  }
  .suggestion-item:last-child {
    border-bottom: none;
  }
  .suggestion-item:hover, .suggestion-item.active {
    background: #f9f5ef;
    color: #c15a2e;
  }
  .highlight {
    background: #ffe5d0;
    color: #c15a2e;
    font-weight: bold;
    border-radius: 3px;
    padding: 0 2px;
  }
</style>
{% endblock %}